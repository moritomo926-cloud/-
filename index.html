<script>
    let db = JSON.parse(localStorage.getItem('later_reading_db')) || [];
    let isChecking = false;

    // iOS対策：画面タップ時にクリップボードを確認
    document.body.addEventListener('click', async () => {
        if (isChecking) return;
        await checkClipboard();
    });

    // アプリに戻った時に確認
    window.addEventListener('focus', checkClipboard);

    async function checkClipboard() {
        isChecking = true;
        try {
            const text = await navigator.clipboard.readText();
            // URL形式かつ、最後に登録したものと違う場合のみ反応
            if (text.startsWith('http') && (!db[0] || db[0].url !== text)) {
                if (confirm("コピーされているURLを保存しますか？\n" + text)) {
                    addLinkEntry(text);
                    // 連続反応防止のために一度空にする（任意）
                    await navigator.clipboard.writeText("");
                }
            }
        } catch (e) {
            console.log("アクセス拒否または非対応");
        } finally {
            setTimeout(() => { isChecking = false; }, 1000);
        }
    }

    async function manualAddLink() {
        let clipText = "";
        try { clipText = await navigator.clipboard.readText(); } catch (e) {}
        const url = prompt("URLを入力してください", clipText.startsWith('http') ? clipText : "");
        if (url) addLinkEntry(url);
    }

    function addLinkEntry(url) {
        const videoId = extractVideoId(url);
        const isYT = videoId !== null;
        const entry = {
            id: Date.now(),
            type: isYT ? 'video' : 'link',
            url: url,
            thumb: isYT ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : 'https://via.placeholder.com/150/34C759/FFFFFF?text=NEWS',
            text: (isYT ? "YouTube: " : "Link: ") + url,
            tags: isYT ? ['動画'] : ['ニュース'],
            timestamp: new Date().toLocaleDateString()
        };
        db.unshift(entry);
        saveAndRender();
    }

    function extractVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // --- 以下、前回のOCR処理・描画処理（render等）を継続 ---
    async function processImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('loader').style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async (e) => {
            const result = await Tesseract.recognize(e.target.result, 'jpn+eng', {
                logger: m => { if(m.status === 'recognizing text') document.getElementById('progress').innerText = Math.floor(m.progress * 100) + '%'; }
            });
            db.unshift({ id: Date.now(), type: 'screenshot', img: e.target.result, text: result.data.text, tags: ['スクショ'], timestamp: new Date().toLocaleDateString() });
            saveAndRender();
            document.getElementById('loader').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    function saveAndRender() { localStorage.setItem('later_reading_db', JSON.stringify(db)); render(); }

    function render() {
        const grid = document.getElementById('grid');
        const query = document.getElementById('searchInput').value.toLowerCase();
        grid.innerHTML = '';
        db.filter(item => item.text.toLowerCase().includes(query)).forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            const color = item.type === 'video' ? '#FF0000' : (item.type === 'link' ? '#34C759' : '#007AFF');
            div.innerHTML = `
                <div class="type-badge" style="background:${color}">${item.type}</div>
                <img src="${item.type === 'screenshot' ? item.img : item.thumb}" onclick="openItem('${item.type}', '${item.url}', \`${item.text}\`)">
                <div class="info">
                    <div class="title">${item.text}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span style="font-size:9px; color:#888;">${item.timestamp}</span>
                        <span style="color:red; font-size:10px; cursor:pointer;" onclick="deleteItem(${item.id})">削除</span>
                    </div>
                </div>`;
            grid.appendChild(div);
        });
    }

    function openItem(type, url, text) { type === 'screenshot' ? alert(text) : window.open(url, '_blank'); }
    function deleteItem(id) { if(confirm("削除しますか？")) { db = db.filter(i => i.id !== id); saveAndRender(); } }
    render();
</script>
